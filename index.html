<!DOCTYPE html>	
<html>
<head>

  <title>Dashboard</title>

  <!-- Meta Tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=320; initial-scale=1.0; user-scalable=0;" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  <!-- Icon -->
  <link rel="apple-touch-icon-precomposed" href="img/button.png" />

  <!-- Scripts -->
  <script src="http://yui.yahooapis.com/3.4.0/build/yui/yui-min.js"></script>    
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js" type="text/javascript"></script> 
  <script src="scripts/jquery.ba-bbq.js" type="text/javascript"></script>
  <script src="scripts/api.js" type="text/javascript"></script>

  <!-- Styles -->
  <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>

  <div id="header">
    <a href="">Loading venue...</a>
  </div>

  <div id="scrollview-content">
  
    <div id="viewSpecials" class="view">
    
      <h2 style="display: none;">Create Flash Special</h2>
      <div class="box graph createSpecial" style="display: none;">
        <p>When a customer is one of the first</p>
        <p><input type="text" value="10" class="inputBig" /></p>
        <p>people to check in between</p>
        <p><input type="text" value ="6" class="inputBig" /> and <input type="text" value ="10" class="inputBig" /> &nbsp;pm</p>
        <p>they will unlock and receive</p>
        <p><textarea class="inputBig">a free appetizer…</textarea></p>
        <p><div class="button">Get me customers now!</div></p>
      </div>
  
      <div id="specials">
      </div>
      
      <p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
      <p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
      <p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
      <p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
    
    </div><!-- end #viewSpecials -->
    
    <div id="viewStats" class="view">
    
      <h2>Stats</h2>
      
      <div class="statsRow">
        <div class="statsBlock">1,378</div>
        <div class="statsBlock">6,158</div>
        <div class="statsBlock">7.12</div>
      </div>
      
      <div class="statsRow">
        <div class="statsTitle">People</div>
        <div class="statsTitle">Checkins</div>
        <div class="statsTitle">Avg. P/Day</div>
      </div>
      
      <div class="statsRow">
        <div class="statsBlock">17</div>
        <div class="statsBlock">44</div>
        <div class="statsBlock">8</div>
      </div>
      
      <div class="statsRow">
        <div class="statsTitle">Photos</div>
        <div class="statsTitle">Tips</div>
        <div class="statsTitle">Lists</div>
      </div>
      
      <br />
      
      <h2>Check-ins vs New Visitors</h2>
      <div class="box graph"><img src="img/graph1.png" alt="" width="288" /></div>
      
      <h2>Time Breakdown</h2>
      <div class="box graph"><img src="img/graph2.png" alt="" width="288" /></div>
      
      <h2>Gender</h2>
      <div class="box graph"><img src="img/graph3.png" alt="" width="288" /></div>
      
      <h2>Age</h2>
      <div class="box graph"><img src="img/graph4.png" alt="" width="288" /></div>
      
    </div><!-- end #viewStats -->
    
    <div id="viewDetails" class="view">
      <h2>Your Venue Details</h2>
      
      <h2><span class="mayorFloat">Last 60 Days</span>Mayor</h2>
      <div class="box mayor"><span class="mayorFloat" id="mayorCount"></span>
	<span id="mayor"></span>
      </div>
      
      <h2>Latest Photos</h2>
      <div class="photos" id="photos">
      </div>
      
      <br />
      
      <h2>Categories and Tags</h2>
      <p class="small" id="categories"></p>
      <p class="small" id="tags"><p>
      
      <br />
      
      <h2>Twitter Mentions</h2>
      <p class="small"><strong>@dens</strong> - foursquare team outing number #848 (@ The Scratcher) http://4sq.com/2rdBhD</p>
      <p class="small"><strong>@sambrown</strong> - New new, old, new old, new foursquare hangout (@ The Scratcher) http://4sq.com/2rdBhD</p>
      
    </div><!-- end #viewDetails -->
    
    <div id="viewProfile" class="view">
      <h2>Profile Page</h2>
      <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.<br /><br /></p>
      <p>Lovingly made in New York City<br /><br /></p>
      <p>Logout<br /><br /></p>
      <p>ツ</p>
    </div><!-- end #viewProfile -->

    <div id="viewHere" class="view">
      <div id="currUser">
        <img style="float:left">
        <b><span id="name"></span></b><br/>
        4 minutes ago<br/>
        10 total check-ins
      </div>
      <div id="hereNow" style="clear:both">
      </div>
    </div> <!-- end #viewUser -->
  
  </div><!-- end #scrollview-content -->
  
  <div id="footer">
    <a href="#viewSpecials" class="selected">Specials</a><a href="#viewStats">Stats</a><a href="#viewDetails">Details</a><a href="#viewHere">Here</a>
  </div>
  
<script type="text/javascript" charset="utf-8">

  // Switch views
  $("#footer a").click(function(e) {
    $("#scrollview-content .view").hide();
    $(this.hash).show();
    $("#footer a").removeClass("selected");
    $(this).addClass("selected");
  });
  
  var selectedTab = '';
  if ($.deparam.querystring()['uid'] != null) {
    selectedTab = '#viewHere';
  } else {
    selectedTab = '#viewSpecials';
  }
  $("#scrollview-content .view:not(" + selectedTab + ")").hide();

  // YUI Scroll
  YUI().use('scrollview-base', function(Y) {
    var height = 0;
    if (window.navigator.standalone == true) {
      height = 367;
    } else {
      height = 323;
    }

    var scrollView = new Y.ScrollView({
        id:"scrollview",
        srcNode: '#scrollview-content',
        height: height,
        flick: {
            minDistance:10,
            minVelocity:0.3,
            axis: "y"
        }
    });

    scrollView.render();
  })

  function showUser(vid, uid, photo, name) {
    $('#currUser img').attr('src', photo);
    $('#currUser #name').html(name);
    app.foursquare.stats(vid, function(stats) {
      console.log(stats)
    })
  }

  function App(apiKey, authUrl, apiUrl) {
    this.foursquare = new Foursquare(apiKey, authUrl, apiUrl);
    this.run = function() {
      this.foursquare.venuesManaged(bind(this.onVenuesManaged, this));
      this.foursquare.listSpecials(bind(this.onListSpecials, this));
    };
  }

  App.prototype.onVenuesManaged = function(_venue) {
    this.foursquare.venue(_venue.id, bind(this.onVenue, this));
  }

  App.prototype.onVenue = function(_venue) {
    this.vid = _venue.id;
    this.foursquare.herenow(this.vid, bind(this.onHereNow, this));

    // Category icon & title
    var cat = _venue.categories[0].icon;
    $('#header a').html('<img src="'+cat+'"/>' + _venue.name);

    // Mayor
    var mayor = _venue.mayor.user;
    $('#mayorCount').html(_venue.mayor.count + ' check-ins');
    $('#mayor').html('<img src="'+ mayor.photo+'" height="32" width="32"/>' + mayor.firstName + ' ' + mayor.lastName);

    // Photos
    var photos = [];
    for (i = 0; i < _venue.photos.groups.length; i++) {
      photos = photos.concat(_venue.photos.groups[i].items);
    }
    var div = $('#photos');
    for (i = 0; i < 4 && i < photos.length; i++) {
      var photo = photos[i];
      div.append('<img src="'+photo.sizes.items[2].url+'"/>');
    }

    // Categories & tags
    var cats = _venue.categories.map(function(c) { return c.name }).join(',');
    $('#categories').html('<strong>'+cats+'</strong>');
    $('#tags').html(_venue.tags.join(', '));
  }

  App.prototype.onHereNow = function(_hereNow) {
    var hn = $('#hereNow');
    hn.append('<p><strong>' + _hereNow.count +  ' people</strong> are checked in here right now</p>');
    for (var u in _hereNow.items) {
      var user = _hereNow.items[u].user;
      var fullName = user.firstName + ' ' + user.lastName[0] + '.';
      if (u == 0) {
        showUser(this.vid, user.id, user.photo, fullName);
      }
      var args = [ this.vid, user.id, user.photo, fullName ];
      var onClick = 'showUser(' + args.map(function(a) { return '\''+a+'\'' }).join(',') + ')';

      hn.append('<img onclick="' + onClick + '" src="' + _hereNow.items[u].user.photo + '" alt="' + _hereNow.items[u].user.firstName + '" width="32" height="32" />');
    }
  }

  App.prototype.onListSpecials = function(specials) {
    var img = function(type) { return '<img src="http://foursquare.com/img/specials/'+type+'.png" alt="" width="32" height="32" />' }
    var onButton = function(sid, vid) { return '<a href="#" class="button" onclick="activateSpecial(\''+sid+'\', \''+vid+'\')">ENABLE</a>' }
    var offButton = function(cid) { return '<div href="#" class="button" onclick="deactivateSpecial(\''+cid+'\')">DISABLE</div>' }
    var self = this;

    self.foursquare.listCampaigns(function(campaigns) {
      var specialToCampaign = {};
      for (var i = 0; i < campaigns.count; i++) {
        var campaign = campaigns.items[i];
        specialToCampaign[campaign.specialId] = campaign;
      }

      for (var i = 0; i < specials.count; i++) {
        var special = specials.items[i];
        self.foursquare.getSpecial(special.id, function(special) {
          var c = specialToCampaign[special.id];
          var title = '<div class="specialTitle">' + img(special.type) + '<b>'+special.type+' special</b></div>';
          var content = '<div class="content">' + special.text;
          var endContent = '<div style="clear:both"></div></div>';
          var div = $('#specials');
          if (c) {
            div.append('<div class="box enabled">' + title + content + offButton(c.id) + endContent + '</div>');
          } else {
            div.append('<div class="box disabled">' + title + content + onButton(special.id, self.vid) + endContent + '</div>');
          }
        });
      }
    })
  }

  function redraw() {
    $('#specials').empty();
    app.foursquare.listSpecials(bind(app.onListSpecials, app));
  }

  function activateSpecial(specialId, venueId) {
    app.foursquare.activateSpecial(specialId, venueId, function() {
      redraw();
    })
  }

  function deactivateSpecial(campaignId) {
    app.foursquare.deactivateCampaign(campaignId, function() {
      redraw();
    })
  }

  var app = null;

  $(function() {
    app = new App('VMIFWZFUBHZDDWDRLC0SLXLUIUF1TJDMZCPYRQBRWG3S1C0E', 'http://foursquare.com/', 'https://api.foursquare.com/');
    app.run();
  })

</script>

<form style="display:none" id="activateSpecialForm" action="https://api.foursquare.com/v2/campaigns/add" method="POST" target="response">
  <input type="hidden" name="oauth_token" id="oauth_token"/>
  <input type="hidden" name="specialId" id="specialId"/>
  <input type="hidden" name="venueId" id="venueId"/>
  <input type="hidden" name="startAt" id="startAt" value="0"/>
</form>

<form style="display:none" id="deactivateSpecialForm" action="https://api.foursquare.com/v2/campaigns/end" method="POST" target="response">
  <input type="hidden" name="oauth_token" id="oauth_token"/>
</form>

<iframe style="display:none" name="response" onload="redraw()"></iframe>

</body>
</html>
